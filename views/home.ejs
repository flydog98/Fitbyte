<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <style>
      p {
        color: black;
        border-width: 8px;
        border-style: solid;
        border-color: rgb(241, 248, 213);
        padding: 15px;
        background-color: rgb(245, 248, 228);
        /* 축약형 */
        border: 5px solid rgba(82, 99, 116, 0);
        height: 400px;
        border-radius: 1.5rem;
        margin-right: 15px;
      }
      .full_screen {
        background-color: aliceblue;
        height: 1000px;
      }
      .search {
        color: rgb(15, 150, 150);
      }
      img {
        width: 600px;
        height: 400px;
      }
      .d-flex {
        margin-left: 15px;
        width: 450px;
      }
      .navbar-brand {
        margin-left: 350px;
      }

      Text {
        font-size: 35px;
        font-weight: bold;
      }

      .add {
        margin-top: 400px;
        width: 2000px;
        height: 1000px;
        background-color: rgb(229, 240, 250);
      }

      .column {
        float: left;
        width: 50%;
        height: 300px;
        padding: 10px;
      }
      .column h2 {
        margin-top: 0;
      }
      .task {
        background-color: #f2f2f2;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        cursor: grab;
      }
      .task:active {
        cursor: grabbing;
      }
    </style>
    <%- include('./partials/head') %>
  </head>
  <body>
    <%- include('./partials/nav') %>
    <div class="full_screen">
      <div class="container mb-3">
        <div class="container px-4 py-5" id="icon-grid">
          <form method="POST" action="/time-promise">
            <h2 class="pb-2 border-bottom">목표 운동 시간</h2>
            <label>목표 시간: </label>
            <input type="number" name="amount" min="1" max="1440" required />
            분
            <button type="submit">입력</button>
          </form>

          <% if (todayTimePromise && todayTimePromise.amount != null) { %>
          <p>
            <%= Math.floor(todayTimePromise.amount/60) %>시간 <%=
            todayTimePromise.amount%60 %>분
          </p>
          <% } else { %>
          <p>목표 운동 시간을 설정해주세요.</p>
          <% } %>

          <div style="margin-bottom: 40px"></div>

          <h2 class="pb-2 border-bottom">운동 약속</h2>
          <div class="list-group">
            <!--ADD-->
            <label class="list-group-item d-flex gap-3 bg-body-tertiary">
              <form id="add-task-form">
                <input type="datetime-local" name="date" required />
                <input type="number" name="amount" required />
                <input type="text" name="contents" required />
                <button type="submit" class="btn btn-primary">Add</button>
              </form>
            </label>
            </div>

            <script>
              const timePromiseForm = document.querySelector("#icon-grid form[action='/time-promise']");
  timePromiseForm.addEventListener("submit", function (event) {
    event.preventDefault();
    const amountInput = timePromiseForm.querySelector('input[name="amount"]');
    const amount = amountInput.value ? parseInt(amountInput.value, 10) : null;
    fetch("/time-promise", {
      method: "POST",
      body: JSON.stringify({ amount }),
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data && data.amount !== null) {
          const amountElement = document.createElement("p");
          amountElement.innerHTML = `목표 운동 시간 ${Math.floor(data.amount / 60)}시간 ${
            data.amount % 60
          }분`;
          document.querySelector("#icon-grid").appendChild(amountElement);
        }
      });
  });


              const addTaskForm = document.getElementById("add-task-form");

              addTaskForm.addEventListener("submit", async (event) => {
                event.preventDefault();


                const formData = new FormData(event.target);
                const response = await fetch("/self-promise", {
                  method: "POST",
                  body: formData,
                });

                if (!response.ok) {
                  console.error("Failed to add task");
                  return;
                }

                const task = await response.json();
                const taskItem = document.createElement("label");
                taskItem.classList.add("list-group-item", "d-flex", "gap-3");
                taskItem.innerHTML = `
                <input class="form-check-input flex-shrink-0" type="checkbox" value="" style="font-size: 1.375em;">
                <span class="pt-1 form-checked-content">
                  <strong>${task.contents}</strong>
                  <small class="d-block text-body-secondary">
                    <svg class="bi me-1" width="1em" height="1em"><use xlink:href="#calendar-event"/></svg>
                    ${task.date} for ${task.amount} minutes
                  </small>
                </span>
              `;

              const taskList = document.querySelector(".list-group");
                taskList.insertBefore(
                  taskItem,
                  addTaskForm.closest(".list-group-item")
                );
                addTaskForm.reset();
              });
            </script>
          </div>

          <div style="margin-bottom: 60px"></div>

          <a
            href="http://13.209.155.211:3000/d/b1851fe4-77e8-42cb-976f-64ab5e30df6b/raspberrypi-test?orgId=1"
            target="_blank"
            style="color: blue; font-size: 25px"
            >나의 헬스 데이터</a>

          <div style="margin-bottom: 60px"></div>

          <h2 class="pb-2 border-bottom">주변 운동시설 및 등산로</h2>
        </div>
      </div>
    </div>
  </body>
</html>
